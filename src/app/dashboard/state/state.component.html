<p-panel *ngIf="state && car" header="Состояние {{car.name}}" [toggleable]="toggleable">
    <div>
        <div class="alert alert-danger" *ngFor="let issue of state.issues">
            <div class="text-left">
                <span class="fa fa-warning">&nbsp;</span>
                <strong>{{issue.name}}</strong>
            </div>
            <div class="text-left">Прогноз: {{issue.forecast}}</div>
            <hr/>
            <div class="text-right">
                <button *ngIf="!isMuted(issue.id)" class="btn btn-danger" (click)="mute(issue.id)">
                    <span class="fa fa-music">&nbsp;</span>
                    включен
                </button>
                <button *ngIf="isMuted(issue.id)" class="btn btn-success" (click)="unMute(issue.id)">
                    <span class="fa fa-music">&nbsp;</span>
                    отключен
                </button>
            </div>
        </div>
        <div class="alert alert-success" *ngIf="!state.issues.length">
            <span class="fa fa-check">&nbsp;</span>Проблем не обнаружено
        </div>
    </div>
    <div class="alert alert-success">
        <div>
            Статус:
            <span *ngIf="online(state)" class="badge alert-success">в сети</span>
            <span *ngIf="!online(state)" class="badge alert-danger">не в сети</span>
        </div>
        <div>
            Двигатель:
            <span *ngIf="state.engine" class="badge alert-success">работает</span>
            <span *ngIf="!state.engine" class="badge alert-danger">заглушен</span>
        </div>
        <div *ngIf="!compact">
            GSM:
            <span *ngIf="state.gsm" class="badge alert-success">вкл</span>
            <span *ngIf="!state.gsm" class="badge alert-danger">выкл</span>
        </div>
        <div *ngIf="!compact">
            Время:
            <span *ngIf="state.watch" class="badge alert-success">синхронизовано</span>
            <span *ngIf="!state.watch" class="badge alert-danger">не синхронизовано</span>
        </div>
        <div *ngIf="!compact">
            Сеть:
            <span *ngIf="state.network" class="badge alert-success">вкл</span>
            <span *ngIf="!state.network" class="badge alert-danger">выкл</span>
        </div>
        <div *ngIf="!compact">
            Сигнал: {{state.networkSignal}}%
        </div>
        <div *ngIf="!compact">
            Роуминг:
            <span *ngIf="state.roaming" class="badge alert-danger">да</span>
            <span *ngIf="!state.roaming" class="badge alert-success">нет</span>
        </div>
        <div *ngIf="!compact">
            Питание:
            <span *ngIf="state.power" class="badge alert-success">да</span>
            <span *ngIf="!state.power" class="badge alert-danger">нет</span>
        </div>
        <div *ngIf="!compact">
            Моточасы: {{state.motochas}} ч.
        </div>
    </div>
    <div *ngIf="!compact && state.maintenances.length">
        <div class="alert" *ngIf="scheduled(state)">До ТО: {{state.maintenances.scheduled.limits.hours -
            state.maintenances.scheduled.value.hours}} ч.
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" (click)="showTODialog()" pButton icon="fa-refresh"
                        title="Провести техническое обслуживание"></button>
                <button type="text" (click)="showTOHistory()" pButton icon="fa-info"
                        title="История технического обслуживания"></button>
            </span>
        </div>
        <div *ngIf="!scheduled(state)" class="alert alert-danger">
            Необходимо пройти ТО
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" (click)="showTODialog()" pButton icon="fa-refresh"
                        title="Провести техническое обслуживание"></button>
                <button type="text" (click)="showTOHistory()" pButton icon="fa-info"
                        title="История технического обслуживания"></button>
            </span>
        </div>
        <div *ngIf="garanted(state)" class="alert">Гарантийное обслуживание заканчивается через
            {{state.maintenances.capital.limits.days - state.maintenances.capital.value.days}}
            д. или {{state.maintenances.capital.limits.hours - state.maintenances.capital.value.hours}} моточасов.
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" class="ui-button-success" (click)="showGarantedDialog()" pButton icon="fa-refresh"
                        title="Продлить гарантийное обслуживание"></button>
                <button type="text" class="ui-button-success" (click)="showGarantedHistory()" pButton icon="fa-info"
                        title="История гарантийного обслуживания"></button>
            </span>
        </div>
        <div *ngIf="!garanted(state)" class="alert alert-danger">
            Гарантийное обслуживание завершено
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" class="ui-button-success" (click)="showGarantedDialog()" pButton icon="fa-refresh"
                        title="Продлить гарантийное обслуживание"></button>
                <button type="text" class="ui-button-success" (click)="showGarantedHistory()" pButton icon="fa-info"
                        title="История гарантийного обслуживания"></button>
            </span>
        </div>
    </div>
    <div *ngIf="!compact" class="label label-default">
        Информация за {{state.time}}
    </div>
</p-panel>
<p-blockUI [blocked]="display || displayGaranted || displayHistory || displayGarantedHistory"></p-blockUI>
<p-dialog header="Техническое обслуживание" #dialog [(visible)]="display">
    <form [formGroup]="form" (ngSubmit)="onSubmitTO()" novalidate class="dialog input-group">
        <label>Дата ТО</label>
        <br/>
        <p-calendar formControlName="created_at" dateFormat="dd.mm.yy" showTime="showTime" hourFormat="24" required
                    [locale]="ru"></p-calendar>
        <br/>
        <label>Комментарий</label>
        <br/>
        <textarea formControlName="comment" pInputTextarea required></textarea>
        <div class="bottom">
            <button type="submit" class="ui-button-success" [disabled]="!form.valid || submit" icon="fa-check" pButton
                    label="Сбросить"></button>
        </div>
    </form>
</p-dialog>
<p-dialog header="Гарантийное обслуживание" #dialogGaranted [(visible)]="displayGaranted">
    <form [formGroup]="form" (ngSubmit)="onSubmitGaranted()" novalidate class="dialog input-group">
        <label>Дата с которой начать гарантийное обслуживание</label>
        <br/>
        <p-calendar formControlName="created_at" dateFormat="dd.mm.yy" showTime="showTime" hourFormat="24" required
                    [locale]="ru"></p-calendar>
        <br/>
        <label>Комментарий</label>
        <br/>
        <textarea formControlName="comment" pInputTextarea required></textarea>
        <div class="bottom">
            <button type="submit" class="ui-button-success" [disabled]="!form.valid || submit" icon="fa-check" pButton
                    label="Сбросить"></button>
        </div>
    </form>
</p-dialog>
<p-dialog header="История технического обслуживания" #dialogHistory [(visible)]="displayHistory">
    <div *ngFor="let h of history">
        <span class="badge">{{h.created_at | date:'dd.MM.y HH:mm'}}</span> {{h.comment}}
    </div>
</p-dialog>
<p-dialog header="История гарантийного обслуживания" #dialogGarantedHistory [(visible)]="displayGarantedHistory">
    <div *ngFor="let h of garantedHistory" [class.alert-success]="h.active">
        <span class="badge">{{h.date | date:'dd.MM.y HH:mm'}}</span> {{h.comment}}
    </div>
</p-dialog>