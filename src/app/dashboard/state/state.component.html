<p-panel *ngIf="state && car" header="{{ 'dashboard.stateOn' | translate: {value: car.name} }}"
         [toggleable]="toggleable">
    <div>
        <div class="alert alert-danger" *ngFor="let issue of state.issues">
            <div class="text-left">
                <span class="fa fa-warning">&nbsp;</span>
                <strong>{{issue.name}}</strong>
            </div>
            <div class="text-left" *ngIf="issue.forecast.length">{{ 'dashboard.forecast' | translate }}:</div>
            <ul>
                <li *ngFor="let forecast of issue.forecast">
                    {{forecast.name}}
                </li>
            </ul>
            disable
            <hr/>
            <div class="text-right">
                <button *ngIf="!isMuted(issue.id)" class="btn btn-success" (click)="mute(issue.id)">
                    <span class="fa fa-music">&nbsp;</span>
                    {{ 'dashboard.enabled' | translate }}
                </button>
                <button *ngIf="isMuted(issue.id)" class="btn btn-danger" (click)="unMute(issue.id)">
                    <span class="fa fa-music">&nbsp;</span>
                    {{ 'dashboard.disabled' | translate }}
                </button>
            </div>
        </div>
        <div class="alert alert-success" *ngIf="!state.issues.length">
            <span class="fa fa-check">&nbsp;</span>{{ 'dashboard.noProblemsFound' | translate }}
        </div>
    </div>
    <div class="alert alert-success">
        <div>
            {{ 'dashboard.imei' | translate }}:
            <span class="badge alert-success">{{state.imei}}</span>
        </div>
        <div>
            {{ 'dashboard.status' | translate }}:
            <span *ngIf="online(state)" class="badge alert-success">{{ 'dashboard.online' | translate }}</span>
            <span *ngIf="!online(state)" class="badge alert-danger">{{ 'dashboard.offline' | translate }}</span>
        </div>
        <div>
            {{ 'dashboard.engine' | translate }}:
            <span *ngIf="state.engine" class="badge alert-success">{{ 'dashboard.working' | translate }}</span>
            <span *ngIf="!state.engine" class="badge alert-danger">{{ 'dashboard.muffled' | translate }}</span>
        </div>
        <div *ngIf="!compact">
            {{ 'dashboard.gsm' | translate }}:
            <span *ngIf="state.gsm" class="badge alert-success">{{ 'dashboard.on' | translate }}</span>
            <span *ngIf="!state.gsm" class="badge alert-danger">{{ 'dashboard.off' | translate }}</span>
        </div>
        <div *ngIf="!compact">
            {{ 'dashboard.time' | translate }}:
            <span *ngIf="state.watch" class="badge alert-success">{{ 'dashboard.synchronized' | translate }}</span>
            <span *ngIf="!state.watch" class="badge alert-danger">{{ 'dashboard.notSynchronized' | translate }}</span>
        </div>
        <div *ngIf="!compact">
            {{ 'dashboard.network' | translate }}:
            <span *ngIf="state.network" class="badge alert-success">{{ 'dashboard.on' | translate }}</span>
            <span *ngIf="!state.network" class="badge alert-danger">{{ 'dashboard.off' | translate }}</span>
        </div>
        <div *ngIf="!compact">
            {{ 'dashboard.signal' | translate }}: {{state.networkSignal}}%
        </div>
        <div *ngIf="!compact">
            {{ 'dashboard.roaming' | translate }}:
            <span *ngIf="state.roaming" class="badge alert-danger">{{ 'dashboard.yes' | translate }}</span>
            <span *ngIf="!state.roaming" class="badge alert-success">{{ 'dashboard.no' | translate }}</span>
        </div>
        <div *ngIf="!compact">
            {{ 'dashboard.power' | translate }}:
            <span *ngIf="state.power" class="badge alert-success">{{ 'dashboard.yes' | translate }}</span>
            <span *ngIf="!state.power" class="badge alert-danger">{{ 'dashboard.no' | translate }}</span>
        </div>
        <div *ngIf="!compact">
            {{ 'dashboard.machineHours' | translate }}: {{state.motochas}} {{ 'dashboard.h' | translate }}
            <button type="text" (click)="showMotochasFilter()" pButton
                    label="{{ 'dashboard.filter' | translate }}"></button>
        </div>
    </div>
    <p-dialog header="{{ 'dashboard.filterMachineHours' | translate }}" [(visible)]="motochasFilter">
        <form [formGroup]="formMotochasFilter" (ngSubmit)="onSubmitMotochasFilter()" novalidate class="input-group">
            <label>{{ 'dashboard.numberMachineHours' | translate }}</label>
            <br/>
            <input formControlName="motochas" pInput required/>
            <hr *ngIf="motochasFilterAnswer"/>
            <div *ngIf="motochasFilterAnswer">
                <span *ngIf="!motochasFilterAnswer.reached">{{ 'dashboard.dateNotFound' | translate }}</span>
                <span *ngIf="motochasFilterAnswer.reached">{{ 'dashboard.date' | translate }}: {{motochasFilterAnswer.date | date:'dd.MM.y HH:mm'}}</span>
            </div>
            <hr/>
            <button type="submit" class="ui-button-success"
                    [disabled]="!formMotochasFilter.valid || submitMotochasFilter" icon="fa-check" pButton
                    label="{{ 'dashboard.apply' | translate }}"></button>
        </form>
    </p-dialog>


    <div *ngIf="!compact && state.maintenances && user && user.role">
        <div class="alert" *ngIf="scheduled(state)">{{ 'dashboard.toMaintenance' | translate:
            (state.maintenances.scheduled.limits.hours - state.maintenances.scheduled.value.hours) }}
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" (click)="showTODialog()" pButton icon="fa-refresh"
                        title="{{ 'dashboard.carryOutMaintenance' | translate }}"></button>
                <button type="text" (click)="showTOHistory()" pButton icon="fa-info"
                        title="{{ 'dashboard.historyMaintenance' | translate }}"></button>
            </span>
        </div>
        <div *ngIf="!scheduled(state)" class="alert alert-danger">
            {{ 'dashboard.needMaintenance' | translate }}
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" (click)="showTODialog()" pButton icon="fa-refresh"
                        title="{{ 'dashboard.carryOutMaintenance' | translate }}"></button>
                <button type="text" (click)="showTOHistory()" pButton icon="fa-info"
                        title="{{ 'dashboard.historyMaintenance' | translate }}"></button>
            </span>
        </div>
        <div *ngIf="garanted(state)" class="alert">
            {{ 'dashboard.warrantyServiceIsOver' |
            translate: {
            days: (state.maintenances.capital.limits.days - state.maintenances.capital.value.days),
            machineHours: (state.maintenances.capital.limits.hours - state.maintenances.capital.value.hours)
            }
            }}
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" class="ui-button-success" (click)="showGarantedDialog()" pButton icon="fa-refresh"
                        title="{{ 'dashboard.extendWarrantyService' | translate }}"></button>
                <button type="text" class="ui-button-success" (click)="showGarantedHistory()" pButton icon="fa-info"
                        title="{{ 'dashboard.historyWarrantyService' | translate }}"></button>
            </span>
        </div>
        <div *ngIf="!garanted(state)" class="alert alert-danger">
            {{ 'dashboard.warrantyServiceCompleted' | translate }}
            <span *ngIf="user && user.role.is_global == 1 && car.engine" class="btn-st">
                <button type="text" class="ui-button-success" (click)="showGarantedDialog()" pButton icon="fa-refresh"
                        title="{{ 'dashboard.extendWarrantyService' | translate }}"></button>
                <button type="text" class="ui-button-success" (click)="showGarantedHistory()" pButton icon="fa-info"
                        title="{{ 'dashboard.historyWarrantyService' | translate }}"></button>
            </span>
        </div>
    </div>
    <div *ngIf="!compact" class="label label-default">
        {{ 'dashboard.InformationFor' | translate: {value: state.time} }}
    </div>
</p-panel>
<p-blockUI [blocked]="display || displayGaranted || displayHistory || displayGarantedHistory"></p-blockUI>
<p-dialog header="{{ 'dashboard.maintenance' | translate }}" #dialog [(visible)]="display">
    <form [formGroup]="form" (ngSubmit)="onSubmitTO()" novalidate class="dialog input-group">
        <label>{{ 'dashboard.date' | translate }} {{ 'dashboard.maintenance' | translate }}</label>
        <br/>
        <p-calendar formControlName="created_at" dateFormat="dd.mm.yy" showTime="showTime" hourFormat="24" required
                    [locale]="ru"></p-calendar>
        <br/>
        <label>{{ 'dashboard.comment' | translate }}</label>
        <br/>
        <textarea formControlName="comment" pInputTextarea required></textarea>
        <div class="bottom">
            <button type="submit" class="ui-button-success" [disabled]="!form.valid || submit" icon="fa-check" pButton
                    label="{{ 'dashboard.reset' | translate }}"></button>
        </div>
    </form>
</p-dialog>
<p-dialog header="{{ 'dashboard.warrantyService' | translate }}" #dialogGaranted [(visible)]="displayGaranted">
    <form [formGroup]="form" (ngSubmit)="onSubmitGaranted()" novalidate class="dialog input-group">
        <label>{{ 'dashboard.dateStartWarrantyService' | translate }}</label>
        <br/>
        <p-calendar formControlName="created_at" dateFormat="dd.mm.yy" showTime="showTime" hourFormat="24" required
                    [locale]="ru"></p-calendar>
        <br/>
        <label>{{ 'dashboard.comment' | translate }}</label>
        <br/>
        <textarea formControlName="comment" pInputTextarea required></textarea>
        <div class="bottom">
            <button type="submit" class="ui-button-success" [disabled]="!form.valid || submit" icon="fa-check" pButton
                    label="{{ 'dashboard.reset' | translate }}"></button>
        </div>
    </form>
</p-dialog>
<p-dialog header="{{ 'dashboard.historyMaintenance' | translate }}" #dialogHistory [(visible)]="displayHistory">
    <div *ngFor="let h of history">
        <span class="badge">{{h.created_at | date:'dd.MM.y HH:mm'}}</span> {{h.comment}}
    </div>
</p-dialog>
<p-dialog header="{{ 'dashboard.historyWarrantyService' | translate }}" #dialogGarantedHistory
          [(visible)]="displayGarantedHistory">
    <div *ngFor="let h of garantedHistory" [class.alert-success]="h.active">
        <span class="badge">{{h.date | date:'dd.MM.y HH:mm'}}</span> {{h.comment}}
    </div>
</p-dialog>